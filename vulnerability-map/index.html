<!DOCTYPE html>
<html>
  <head>
    <title>View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="map"></div>
    <a href="/" class="float">
      <i class="fa fa-arrow-left"></i>
    </a>
    <div class="info-icon">
      <i class="fas fa-info-circle"></i>
    </div>

    <div id="infopopup" class="info-popup">
      <div class="popup-content">
        <p>Click on markers for more information</p>
        <div>
          <span style="color: #ff0000">&#9632;</span> Verified
          <span style="color: #3fb1ce; margin-left: 10px">&#9632;</span>
          Crowdsourced
        </div>
        <button id="closePopup">Close</button>
      </div>
    </div>

    <script type="module">
      mapboxgl.accessToken =
        "pk.eyJ1IjoiaDNtcyIsImEiOiJjbGpwdmJ6bmQwMG5wM2V0azJwdXFmZ3B0In0.VcvGpQkVfDhgrBTlU9rs3A"; // public access token

      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/satellite-streets-v12",
        center: [85.324, 27.7172], // Initial center coordinates
        zoom: 7, // Initial zoom level
      });

      var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        placeholder: "Search for a location",
      });

      map.addControl(geocoder);

      map.addControl(
        new mapboxgl.GeolocateControl({
          positionOptions: {
            enableHighAccuracy: true,
          },
          trackUserLocation: true,
        })
      );

      var infoIcon = document.querySelector(".info-icon");
      var infoPopup = document.getElementById("infopopup");
      var closePopup = document.getElementById("closePopup");

      infoIcon.addEventListener("click", function () {
        infoPopup.style.display = "flex"; // Show the popup
      });

      closePopup.addEventListener("click", function () {
        infoPopup.style.display = "none"; // Hide the popup
      });

      // You can add your markers here

      // Add the image overlay
      map.on("load", function () {
        map.addSource("imageOverlaySource", {
          type: "image",
          url: "../Fire2.png", // Replace with your image URL
          coordinates: [
            [80.0, 30.0], // Upper-left corner coordinates
            [90.0, 30.0], // Upper-right corner coordinates
            [90.0, 26.0], // Lower-right corner coordinates
            [80.0, 26.0], // Lower-left corner coordinates // Lower-left corner coordinates
          ],
        });

        map.addLayer({
          id: "imageOverlay",
          source: "imageOverlaySource",
          type: "raster",
          paint: {
            "raster-opacity": 0.85,
          },
        });
      });

      const sheetId = "1m26BjRUIkVPMv8czR7V6lIh9ZJy9pswkIxu2ICCobPk";
      const sheetName = encodeURIComponent("Sheet1");
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
      var temp;
      var hum;
      fetch(sheetURL)
        .then((response) => response.text())
        .then((csvText) => handleResponse(csvText));

      function handleResponse(csvText) {
        let sheetObjects = csvToObjects(csvText);
        // sheetObjects is now an Array of Objects
        console.log(sheetObjects);

        // Select the data from the bottom-left and bottom-right corners of the CSV
        temp = sheetObjects[sheetObjects.length - 1].Temperature;
        hum = sheetObjects[sheetObjects.length - 1].Humidity;
        var markers = [
          {
            coordinates: [85.330509,  27.711837]
          },
        ];

        markers.forEach((markerInfo) => {
          var marker = new mapboxgl.Marker()
            .setLngLat(markerInfo.coordinates)
            .setPopup(
              new mapboxgl.Popup().setHTML(
                `<h3>Humidiy is ${hum}% <br> Temperature is ${temp}Â°C</h3>`
              )
            )
            .addTo(map);
        });
      }

      function csvToObjects(csv) {
        const csvRows = csv.split("\n");
        const propertyNames = csvSplit(csvRows[0]);
        let objects = [];
        for (let i = 1, max = csvRows.length; i < max; i++) {
          let thisObject = {};
          let row = csvSplit(csvRows[i]);
          for (let j = 0, max = row.length; j < max; j++) {
            thisObject[propertyNames[j]] = row[j];
          }
          objects.push(thisObject);
        }
        return objects;
      }

      function csvSplit(row) {
        return row.split(",").map((val) => val.substring(1, val.length - 1));
      }
    </script>
  </body>
</html>
